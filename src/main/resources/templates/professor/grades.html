<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Submit Grades - Professor Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    .sidebar {
      height: 100vh;
      background-color: #343a40;
      display: flex;
      flex-direction: column;
    }
    .sidebar a, .logout-form button {
      color: white;
      display: block;
      padding: 0.75rem 1rem;
      text-decoration: none;
      border: none;
      background: none;
      text-align: left;
      width: 100%;
    }
    .sidebar a:hover, .logout-form button:hover {
      background-color: #495057;
    }
    .sidebar a.active {
      background-color: #495057;
      font-weight: bold;
    }
    .logout-form {
      margin-top: auto;
      padding: 0.75rem 1rem;
    }
    .grade-table th, .grade-table td {
      vertical-align: middle;
    }
    .grade-select {
      min-width: 120px;
    }
    .status-badge {
      font-size: 0.85rem;
    }
    .grade-description {
      font-size: 0.8rem;
      color: #6c757d;
      margin-top: 2px;
    }
  </style>
</head>
<body>
<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <nav class="col-md-2 sidebar p-0">
      <div class="p-3 text-white">
        <h4>Professor Panel</h4>
        <p>Logged in as: <span th:text="${professorName}">Professor</span></p>
      </div>
      <a href="/professor/dashboard" class="nav-link"><i class="fas fa-home me-2"></i>Dashboard</a>
      <a href="/professor/schedules" class="nav-link"><i class="fas fa-calendar-alt me-2"></i>My Classes and Schedules</a>
      <a href="/professor/grades" class="nav-link active"><i class="fas fa-chart-line me-2"></i>Submit Grades</a>
      <a href="/professor/calendar" class="nav-link"><i class="fas fa-calendar me-2"></i>Academic Calendar</a>
      <form class="logout-form mt-auto" method="post" action="/logout">
        <button type="submit"><i class="fas fa-sign-out-alt me-2"></i>Logout</button>
      </form>
    </nav>

    <!-- Main Content -->
    <main class="col-md-10 p-4">
      <h2 class="mb-4">Submit Grades</h2>

      <!-- Schedule Selection -->
      <div class="card mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-book me-2"></i>Select Schedule</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <label for="scheduleSelect" class="form-label">Choose a class to grade:</label>
              <select class="form-select" id="scheduleSelect">
                <option value="" selected disabled>-- Select Schedule --</option>
                <option th:each="schedule : ${schedules}"
                        th:value="${schedule.id}"
                        th:data-code="${schedule.subject.code}"
                        th:data-name="${schedule.subject.name}"
                        th:data-section="${schedule.section}"
                        th:data-studentcount="${schedule.customFields['studentCount']}"
                        th:text="${schedule.subject.code + ' - ' + schedule.subject.name + ' (' + schedule.section + ')'}">
                </option>
              </select>
            </div>
            <div class="col-md-6">
              <div class="subject-info mt-4 mt-md-0">
                <p><strong>Subject Code:</strong> <span id="subjectCode">-</span></p>
                <p><strong>Section:</strong> <span id="subjectSchedule">-</span></p>
                <p><strong>Students Enrolled:</strong> <span id="studentsCount">-</span></p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Grades Submission Form -->
      <div class="card d-none" id="gradesCard">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="fas fa-edit me-2"></i>Submit Grades for <span id="selectedSubject">Selected Schedule</span></h5>
          <div>
            <span class="badge bg-warning status-badge" id="submissionStatus">Draft</span>
          </div>
        </div>
        <div class="card-body">
          <form method="post" th:action="@{/professor/submit-grades}">
            <input type="hidden" name="scheduleId" id="hiddenScheduleId">
            <input type="hidden" name="studentIds" id="hiddenStudentIds">

            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              <strong>Grading System:</strong> 1.00 (Excellent), 1.25, 1.50, 1.75, 2.00, 2.25, 2.50, 2.75, 3.00 (Pass), 5.00 (Fail)
            </div>

            <div class="table-responsive">
              <table class="table table-striped table-hover grade-table">
                <thead class="table-dark">
                <tr>
                  <th>Student ID</th>
                  <th>Student Name</th>
                  <th>Final Rating</th>
                </tr>
                </thead>
                <tbody id="studentsTable">
                <!-- Dynamically populated via JS -->
                </tbody>
              </table>
            </div>

            <div class="d-flex justify-content-between mt-4">

              <button type="submit" class="btn btn-success">
                <i class="fas fa-paper-plane me-1"></i>Submit to Registrar
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- Empty State -->
      <div class="text-center py-5" id="emptyState">
        <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
        <h4 class="text-muted">No Schedule Selected</h4>
        <p class="text-muted">Please select a class from the dropdown to view and submit grades.</p>
      </div>
    </main>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const scheduleSelect = document.getElementById('scheduleSelect');
  const gradesCard = document.getElementById('gradesCard');
  const emptyState = document.getElementById('emptyState');
  const studentsTable = document.getElementById('studentsTable');
  const selectedSubject = document.getElementById('selectedSubject');
  const subjectCode = document.getElementById('subjectCode');
  const subjectSchedule = document.getElementById('subjectSchedule');
  const studentsCount = document.getElementById('studentsCount');
  const hiddenScheduleId = document.getElementById('hiddenScheduleId');
  const hiddenStudentIds = document.getElementById('hiddenStudentIds');

  // Grade options with descriptions
  const gradeOptions = [
    { value: "", text: "-- Select Grade --", description: "" },
    { value: "1.00", text: "1.00", description: "Excellent (97-100%)" },
    { value: "1.25", text: "1.25", description: "Very Good (94-96%)" },
    { value: "1.50", text: "1.50", description: "Good (91-93%)" },
    { value: "1.75", text: "1.75", description: "Very Satisfactory (88-90%)" },
    { value: "2.00", text: "2.00", description: "Satisfactory (85-87%)" },
    { value: "2.25", text: "2.25", description: "Fair (82-84%)" },
    { value: "2.50", text: "2.50", description: "Pass (79-81%)" },
    { value: "2.75", text: "2.75", description: "Conditional (76-78%)" },
    { value: "3.00", text: "3.00", description: "Failure (75%)" },
    { value: "5.00", text: "5.00", description: "Incomplete" }
  ];

  // Function to create grade dropdown
  function createGradeDropdown() {
    let dropdown = '<select name="finalRating" class="form-select form-select-sm grade-select" required>';
    gradeOptions.forEach(option => {
      dropdown += `<option value="${option.value}">${option.text}</option>`;
    });
    dropdown += '</select>';
    dropdown += '<div class="grade-description" id="gradeDesc-${studentId}"></div>';
    return dropdown;
  }

  // Update grade description when selection changes
  function updateGradeDescription(selectElement, studentId) {
    const selectedValue = selectElement.value;
    const descriptionElement = document.getElementById(`gradeDesc-${studentId}`);
    if (descriptionElement) {
      const selectedOption = gradeOptions.find(opt => opt.value === selectedValue);
      descriptionElement.textContent = selectedOption ? selectedOption.description : '';
    }
  }

  scheduleSelect.addEventListener('change', function () {
    const option = scheduleSelect.options[scheduleSelect.selectedIndex];
    const scheduleId = option.value;
    const code = option.getAttribute('data-code');
    const name = option.getAttribute('data-name');
    const section = option.getAttribute('data-section');
    const count = option.getAttribute('data-studentcount');

    selectedSubject.textContent = code + ' - ' + name + ' (' + section + ')';
    subjectCode.textContent = code;
    subjectSchedule.textContent = section;
    studentsCount.textContent = count;
    hiddenScheduleId.value = scheduleId;

    // Fetch students via AJAX
    fetch('/api/schedules/' + scheduleId + '/students')
      .then(response => response.json())
      .then(data => {
        studentsTable.innerHTML = '';
        let ids = [];

        data.forEach((student) => {
          ids.push(student.id);
          const gradeDropdown = createGradeDropdown().replace('${studentId}', student.id);

          studentsTable.innerHTML += `
            <tr>
              <td>${student.id}</td>
              <td>${student.fullName}</td>
              <td>
                ${gradeDropdown}
              </td>
            </tr>`;
        });

        hiddenStudentIds.value = ids.join(',');
        gradesCard.classList.remove('d-none');
        emptyState.classList.add('d-none');

        // Add event listeners to all grade dropdowns
        document.querySelectorAll('select[name="finalRating"]').forEach(select => {
          const studentId = select.closest('tr').querySelector('td:first-child').textContent;
          select.addEventListener('change', () => updateGradeDescription(select, studentId));
        });
      })
      .catch(error => {
        console.error('Error fetching students:', error);
        alert('Error loading students. Please try again.');
      });
  });

  // Save as draft button functionality
  document.getElementById('saveDraftBtn').addEventListener('click', function() {
    alert('Draft saved successfully! You can continue editing later.');
    document.getElementById('submissionStatus').textContent = 'Draft Saved';
    document.getElementById('submissionStatus').className = 'badge bg-info status-badge';
  });
</script>
</body>
</html>