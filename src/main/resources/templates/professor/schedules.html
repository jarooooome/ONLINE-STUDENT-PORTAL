<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8">
  <title>Professor - My Schedules</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    body { overflow-x: hidden; background-color: #f8f9fa; }
    .sidebar { min-height: 100vh; background-color: #343a40; padding-top: 1rem; }
    .sidebar a, .logout-form button { color: #fff; padding: 0.75rem 1.25rem; text-decoration: none; display: block; border: none; background: none; text-align: left; }
    .sidebar a:hover, .logout-form button:hover { background-color: #495057; }
    .sidebar a.active { background-color: #495057; font-weight: bold; }
    .schedule-card { transition: all 0.3s ease; cursor: pointer; border-left: 4px solid #007bff; }
    .schedule-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .student-list { background-color: #f8f9fa; border-radius: 8px; padding: 20px; margin-top: 15px; }
    .badge-enrolled { background-color: #28a745; }
    .badge-pending { background-color: #ffc107; color: #000; }
    .schedule-days { display: inline-block; margin-right: 5px; padding: 3px 8px; background-color: #e9ecef; border-radius: 4px; font-size: 0.85rem; }
    .time-badge { background-color: #6c757d; color: white; }
    .room-badge { background-color: #17a2b8; color: white; }
    .upload-section { background-color: #f8f9fa; border-radius: 8px; padding: 15px; margin-top: 15px; }
    .uploaded-files-list { max-height: 200px; overflow-y: auto; }
    .file-item { padding: 8px 12px; border-bottom: 1px solid #e9ecef; }
    .file-item:last-child { border-bottom: none; }
    .file-icon { color: #6c757d; margin-right: 8px; }
    .upload-btn { cursor: pointer; }
  </style>
</head>
<body>

<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <nav class="col-md-2 sidebar d-flex flex-column">
      <div class="text-white px-3 mb-4">
        <h4 class="mt-3">Professor Panel</h4>
        <small th:text="'Logged in as: ' + ${#authentication.name}">Professor Name</small>
      </div>

      <a href="/professor/dashboard" class="nav-link"><i class="fas fa-home me-2"></i>Dashboard</a>
      <a href="/professor/schedules" class="nav-link active"><i class="fas fa-calendar-alt me-2"></i>My Classes and Schedules</a>
      <a href="/professor/grades" class="nav-link"><i class="fas fa-chart-line me-2"></i>Submit Grades</a>
      <a href="/professor/calendar" class="nav-link"><i class="fas fa-chart-line me-2"></i>Academic Calendar</a>

      <!-- Logout -->
      <form th:action="@{/auth/logout}" method="post" class="logout-form mt-auto px-3 py-2">
        <button type="submit"><i class="fas fa-sign-out-alt me-2"></i>Logout</button>
      </form>
    </nav>

    <!-- Main Content -->
    <main class="col-md-10 p-4">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-calendar-alt me-2 text-primary"></i>My Class Schedules</h2>
        <span class="badge bg-primary fs-6" th:text="'Total Classes: ' + ${schedules != null ? schedules.size() : 0}"></span>
      </div>

      <!-- Success/Error Messages -->
      <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
        <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
      <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>

      <div class="row" id="schedulesContainer">
        <!-- Schedule Cards -->
        <div th:each="schedule : ${schedules}" class="col-md-6 mb-4 schedule-item">
          <div class="card schedule-card shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                  <h5 class="card-title text-primary" th:text="${schedule.subject?.code + ' - ' + schedule.subject?.name}">Subject Code - Name</h5>
                  <h6 class="card-subtitle mb-2 text-muted" th:text="${schedule.section?.course?.code + '-' + schedule.section?.yearLevel + schedule.section?.name}">Course-Section</h6>
                </div>
                <span class="badge bg-success" th:text="${'Enrolled: ' + (schedule.customFields.studentCount != null ? schedule.customFields.studentCount : 0)}">Enrolled: 0</span>
              </div>

              <!-- Schedule Details -->
              <div class="mb-3">
                <span th:if="${schedule.scheduleDays != null}"
                      th:each="daySchedule : ${schedule.scheduleDays}"
                      class="schedule-days me-1 mb-2"
                      th:text="${daySchedule.day}">Day</span>
                <span class="badge time-badge me-1" th:if="${schedule.scheduleDays != null and !schedule.scheduleDays.empty}"
                      th:text="${schedule.scheduleDays[0].startTime + ' - ' + schedule.scheduleDays[0].endTime}">
                  Time
                </span>
                <span class="badge room-badge" th:text="${'Room: ' + schedule.room}">Room: 101</span>
              </div>

              <!-- Action Buttons -->
              <div class="d-flex gap-2 mb-3">
                <button class="btn btn-sm btn-outline-primary" th:onclick="|showStudents('${schedule.id}')|">
                  <i class="fas fa-users me-1"></i>View Students
                </button>
                <button class="btn btn-sm btn-outline-success upload-btn" th:onclick="|toggleUploadSection('${schedule.id}')|">
                  <i class="fas fa-upload me-1"></i>Upload Materials
                </button>
              </div>

              <!-- Upload Section (Initially Hidden) -->
              <div class="upload-section" th:id="|upload-${schedule.id}|" style="display: none;">
                <h6 class="text-success mb-3"><i class="fas fa-file-upload me-2"></i>Upload Learning Materials</h6>

                <form th:action="@{/professor/upload-material}" method="post" enctype="multipart/form-data" th:id="|uploadForm-${schedule.id}|">
                  <input type="hidden" name="scheduleId" th:value="${schedule.id}">

                  <div class="mb-3">
                    <label for="fileTitle" class="form-label">File Title</label>
                    <input type="text" class="form-control" id="fileTitle" name="fileTitle" required>
                  </div>

                  <div class="mb-3">
                    <label for="fileDescription" class="form-label">Description (Optional)</label>
                    <textarea class="form-control" id="fileDescription" name="fileDescription" rows="2"></textarea>
                  </div>

                  <div class="mb-3">
                    <label for="file" class="form-label">Select File</label>
                    <input type="file" class="form-control" id="file" name="file" required>
                  </div>

                  <button type="submit" class="btn btn-success">
                    <i class="fas fa-upload me-1"></i>Upload File
                  </button>
                </form>

                <!-- Uploaded Files List -->
                <div class="mt-4" th:if="${schedule.customFields.uploadedFiles != null and !schedule.customFields.uploadedFiles.empty}">
                  <h6 class="text-primary mb-3"><i class="fas fa-files me-2"></i>Uploaded Materials</h6>
                  <div class="uploaded-files-list">
                    <div th:each="file : ${schedule.customFields.uploadedFiles}" class="file-item d-flex justify-content-between align-items-center">
                      <div>
                        <i th:class="${file.fileIconClass}"></i>
                        <a th:href="@{/professor/download-material/{id}(id=${file.id})}" th:text="${file.title} ?: ${file.originalFileName}">File Name</a>
                        <small class="text-muted d-block" th:text="${file.description} ?: 'No description'">File description</small>
                      </div>
                      <small class="text-muted" th:text="${#temporals.format(file.uploadDate, 'MMM dd, yyyy')}">Upload date</small>
                    </div>
                  </div>
                </div>

                <div th:if="${schedule.customFields.uploadedFiles == null or schedule.customFields.uploadedFiles.empty}" class="text-center text-muted py-3">
                  <i class="fas fa-file-upload fa-2x mb-2"></i>
                  <p>No materials uploaded for this class yet.</p>
                </div>
              </div>

              <!-- Students List (Initially Hidden) -->
              <div class="student-list" th:id="|students-${schedule.id}|" style="display: none;">
                <h6 class="text-primary mb-3"><i class="fas fa-users me-2"></i>Enrolled Students</h6>

                <div th:if="${schedule.customFields.enrolledStudents != null and !schedule.customFields.enrolledStudents.empty}">
                  <div class="table-responsive">
                    <table class="table table-sm table-hover">
                      <thead class="table-light">
                      <tr>
                        <th>Student ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Status</th>
                      </tr>
                      </thead>
                      <tbody>
                      <tr th:each="student : ${schedule.customFields.enrolledStudents}">
                        <td th:text="${student.studentId}">STU001</td>
                        <td th:text="${student.firstName + ' ' + student.lastName}">John Doe</td>
                        <td th:text="${student.email}">john@example.com</td>
                        <td><span class="badge badge-enrolled">Enrolled</span></td>
                      </tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <div th:if="${schedule.customFields.enrolledStudents == null or schedule.customFields.enrolledStudents.empty}" class="text-center text-muted py-3">
                  <i class="fas fa-user-slash fa-2x mb-2"></i>
                  <p>No students enrolled in this class yet.</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- No Schedules Message -->
        <div th:if="${schedules == null or schedules.empty}" class="col-12">
          <div class="text-center text-muted py-5">
            <i class="fas fa-calendar-times fa-3x mb-3"></i>
            <h4>No Class Schedules Assigned</h4>
            <p>You don't have any class schedules assigned yet.</p>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<!-- Upload Success Modal -->
<div class="modal fade" id="uploadSuccessModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-success"><i class="fas fa-check-circle me-2"></i>Upload Successful</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Your file has been uploaded successfully to this class section.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Function to toggle student list visibility
    window.showStudents = function(scheduleId) {
      const studentList = document.getElementById('students-' + scheduleId);
      const uploadSection = document.getElementById('upload-' + scheduleId);
      const isVisible = studentList.style.display === 'block';

      // Hide upload section if visible
      if (uploadSection) {
        uploadSection.style.display = 'none';
      }

      // Hide all student lists first
      document.querySelectorAll('.student-list').forEach(list => {
        list.style.display = 'none';
      });

      // Show the clicked one if it wasn't already visible
      if (!isVisible) {
        studentList.style.display = 'block';

        // Scroll to the student list
        studentList.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    };

    // Function to toggle upload section visibility
    window.toggleUploadSection = function(scheduleId) {
      const uploadSection = document.getElementById('upload-' + scheduleId);
      const studentList = document.getElementById('students-' + scheduleId);
      const isVisible = uploadSection.style.display === 'block';

      // Hide student list if visible
      if (studentList) {
        studentList.style.display = 'none';
      }

      // Hide all upload sections first
      document.querySelectorAll('.upload-section').forEach(section => {
        section.style.display = 'none';
      });

      // Show the clicked one if it wasn't already visible
      if (!isVisible) {
        uploadSection.style.display = 'block';

        // Scroll to the upload section
        uploadSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    };

    // Auto-expand if there's only one schedule
    const scheduleItems = document.querySelectorAll('.schedule-item');
    if (scheduleItems.length === 1) {
      const firstScheduleId = scheduleItems[0].querySelector('.card').getAttribute('th:id').split('-')[1];
      showStudents(firstScheduleId);
    }

    // Check if URL has upload success parameter
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('upload') === 'success') {
      const modal = new bootstrap.Modal(document.getElementById('uploadSuccessModal'));
      modal.show();
    }
  });
</script>
</body>
</html>