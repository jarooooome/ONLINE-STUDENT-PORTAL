<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Change Password</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary: #4e73df;
      --primary-dark: #224abe;
      --success: #1cc88a;
      --danger: #e74a3b;
      --warning: #f6c23e;
    }

    body {
      background-color: #f5f7fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
    }

    .password-container {
      max-width: 800px;
      width: 100%;
      margin: 0 auto;
      padding: 2rem;
    }

    .password-card {
      border-radius: 0.75rem;
      box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.08);
      overflow: hidden;
      margin-bottom: 2rem;
      border: none;
      transition: transform 0.3s ease;
    }

    .password-card:hover {
      transform: translateY(-5px);
    }

    .password-card .card-header {
      background-color: var(--primary);
      color: white;
      font-weight: 600;
      padding: 1.25rem 1.5rem;
      border-bottom: none;
      font-size: 1.1rem;
    }

    .password-card .card-body {
      padding: 2rem;
      background-color: white;
    }

    .form-label {
      font-weight: 500;
      margin-bottom: 0.75rem;
      color: #495057;
    }

    .form-control {
      padding: 0.85rem 1.25rem;
      border-radius: 0.5rem;
      border: 1px solid #e0e0e0;
      transition: all 0.3s ease;
    }

    .form-control:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 0.25rem rgba(78, 115, 223, 0.2);
    }

    .btn {
      padding: 0.85rem 1.5rem;
      font-weight: 500;
      border-radius: 0.5rem;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background-color: var(--primary);
      border-color: var(--primary);
    }

    .btn-primary:hover {
      background-color: var(--primary-dark);
      border-color: var(--primary-dark);
      transform: translateY(-2px);
    }

    .btn-success {
      background-color: var(--success);
      border-color: var(--success);
    }

    .btn-success:hover {
      background-color: #17a673;
      border-color: #17a673;
      transform: translateY(-2px);
    }

    .alert {
      border-radius: 0.5rem;
      padding: 1.25rem;
      margin-bottom: 1.5rem;
    }

    .password-strength {
      height: 6px;
      background-color: #f0f0f0;
      margin-top: 0.75rem;
      border-radius: 3px;
      overflow: hidden;
    }

    .password-strength-bar {
      height: 100%;
      width: 0%;
      transition: all 0.4s ease;
    }

    .password-instructions {
      font-size: 0.875rem;
      color: #6c757d;
      margin-top: 0.75rem;
      line-height: 1.5;
    }

    .password-visibility {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: #adb5bd;
      transition: color 0.3s ease;
    }

    .password-visibility:hover {
      color: var(--primary);
    }

    .password-input-group {
      position: relative;
    }

    .input-group-text {
      background-color: #f8f9fa;
      transition: all 0.3s ease;
    }

    .input-group:focus-within .input-group-text {
      color: var(--primary);
    }

    .page-title {
      color: var(--primary);
      margin-bottom: 2.5rem;
      text-align: center;
      font-weight: 600;
      font-size: 2rem;
    }

    .step-number {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      background-color: white;
      color: var(--primary);
      border-radius: 50%;
      margin-right: 10px;
      font-size: 0.9rem;
      font-weight: bold;
    }

    .otp-countdown {
      font-size: 0.85rem;
      color: var(--primary);
      font-weight: 500;
      margin-top: 0.5rem;
    }

    .resend-otp {
      cursor: pointer;
      color: var(--primary);
      font-weight: 500;
      text-decoration: underline;
    }

    .resend-otp:hover {
      color: var(--primary-dark);
    }
  </style>
</head>
<body>
<div class="password-container">
  <div>
    <h2 class="page-title">
      <i class="fas fa-key me-2"></i>Change Your Password
    </h2>

    <!-- Display success/error messages -->
    <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>
    <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>
    <div th:if="${message}" class="alert alert-info" th:text="${message}"></div>

    <!-- Request OTP Form -->
    <div class="password-card">
      <div class="card-header">
        <span class="step-number">1</span>
        Request Verification Code
      </div>
      <div class="card-body">
        <form id="otpRequestForm" th:action="@{/student/profile/request-otp}" method="post">
          <div class="mb-4">
            <label for="email" class="form-label">Registered Email Address</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-envelope"></i></span>
              <input type="email" class="form-control" id="email" name="email" th:value="${student.email}" readonly>
            </div>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-primary" id="otpRequestBtn">
              <i class="fas fa-paper-plane me-2"></i>Send Verification Code
            </button>
          </div>
          <div id="otpTimer" class="otp-countdown" style="display: none;"></div>
        </form>
      </div>
    </div>

    <!-- Change Password Form -->
    <div class="password-card">
      <div class="card-header">
        <span class="step-number">2</span>
        Change Password
      </div>
      <div class="card-body">
        <form th:action="@{/student/profile/change-password}" method="post">
          <div class="mb-4">
            <label for="otp" class="form-label">Verification Code</label>
            <div class="input-group">
              <span class="input-group-text"><i class="fas fa-shield-alt"></i></span>
              <input type="text" class="form-control" id="otp" name="otp" placeholder="Enter the 6-digit code" required>
            </div>
            <small class="text-muted">Check your email for the verification code</small>
          </div>

          <div class="mb-4">
            <label for="newPassword" class="form-label">New Password</label>
            <div class="password-input-group">
              <input type="password" class="form-control" id="newPassword" name="newPassword"
                     placeholder="Enter your new password" required>
              <i class="fas fa-eye password-visibility" id="toggleNewPassword"></i>
            </div>
            <div class="password-strength mt-2">
              <div class="password-strength-bar" id="passwordStrengthBar"></div>
            </div>
            <div class="password-instructions">
              <i class="fas fa-info-circle me-1"></i> Password must be at least 8 characters and include uppercase, number, and special character.
            </div>
          </div>

          <div class="mb-4">
            <label for="confirmPassword" class="form-label">Confirm New Password</label>
            <div class="password-input-group">
              <input type="password" class="form-control" id="confirmPassword" name="confirmPassword"
                     placeholder="Re-enter your new password" required>
              <i class="fas fa-eye password-visibility" id="toggleConfirmPassword"></i>
            </div>
          </div>

          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-success">
              <i class="fas fa-save me-2"></i>Update Password
            </button>
            <a href="/student/profile" class="btn btn-outline-secondary">
              <i class="fas fa-arrow-left me-2"></i>Back to Profile
            </a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  // Toggle password visibility
  document.getElementById('toggleNewPassword').addEventListener('click', function() {
    const passwordInput = document.getElementById('newPassword');
    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
    passwordInput.setAttribute('type', type);
    this.classList.toggle('fa-eye-slash');
  });

  document.getElementById('toggleConfirmPassword').addEventListener('click', function() {
    const passwordInput = document.getElementById('confirmPassword');
    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
    passwordInput.setAttribute('type', type);
    this.classList.toggle('fa-eye-slash');
  });

  // Password strength indicator
  document.getElementById('newPassword').addEventListener('input', function() {
    const password = this.value;
    const strengthBar = document.getElementById('passwordStrengthBar');
    let strength = 0;

    // Length check
    if (password.length > 0) strength += 20;
    if (password.length >= 8) strength += 20;

    // Complexity checks
    if (/[A-Z]/.test(password)) strength += 20;
    if (/[0-9]/.test(password)) strength += 20;
    if (/[^A-Za-z0-9]/.test(password)) strength += 20;

    // Update strength bar
    strengthBar.style.width = strength + '%';

    // Color coding
    if (strength < 40) {
      strengthBar.style.backgroundColor = 'var(--danger)';
    } else if (strength < 80) {
      strengthBar.style.backgroundColor = 'var(--warning)';
    } else {
      strengthBar.style.backgroundColor = 'var(--success)';
    }
  });

  // Handle OTP request with AJAX to stay on same page
  $('#otpRequestForm').submit(function(e) {
    e.preventDefault();
    const form = $(this);
    const submitBtn = $('#otpRequestBtn');

    submitBtn.prop('disabled', true);
    submitBtn.html('<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Sending...');

    $.ajax({
      type: "POST",
      url: form.attr('action'),
      data: form.serialize(),
      success: function(response) {
        // Show success message
        $('.alert').remove();
        form.before('<div class="alert alert-success">Verification code has been sent to your email</div>');

        // Start countdown timer (2 minutes)
        startOtpCountdown(120);
      },
      error: function(xhr) {
        // Show error message
        $('.alert').remove();
        form.before('<div class="alert alert-danger">Error sending verification code: ' +
                   (xhr.responseJSON?.message || 'Please try again') + '</div>');
      },
      complete: function() {
        submitBtn.prop('disabled', false);
        submitBtn.html('<i class="fas fa-paper-plane me-2"></i>Send Verification Code');
      }
    });
  });

  // OTP countdown timer
  function startOtpCountdown(duration) {
    const timerDisplay = $('#otpTimer');
    let timer = duration, minutes, seconds;

    timerDisplay.show().html('You can request a new code in <span id="countdown">02:00</span>');

    const interval = setInterval(function() {
      minutes = parseInt(timer / 60, 10);
      seconds = parseInt(timer % 60, 10);

      minutes = minutes < 10 ? "0" + minutes : minutes;
      seconds = seconds < 10 ? "0" + seconds : seconds;

      $('#countdown').text(minutes + ":" + seconds);

      if (--timer < 0) {
        clearInterval(interval);
        timerDisplay.html('<span class="resend-otp" id="resendOtp">Resend verification code</span>');

        $('#resendOtp').click(function() {
          $('#otpRequestBtn').click();
        });
      }
    }, 1000);
  }

  // Add slight animation to buttons on hover
  const buttons = document.querySelectorAll('.btn');
  buttons.forEach(button => {
    button.addEventListener('mouseenter', () => {
      button.style.transform = 'translateY(-2px)';
    });
    button.addEventListener('mouseleave', () => {
      button.style.transform = 'translateY(0)';
    });
  });
</script>
</body>
</html>