<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Manage Grades - Registrar Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
  <style>
    .badge-submitted { background-color: #17a2b8; }
    .badge-published { background-color: #28a745; }
    .badge-draft { background-color: #ffc107; color: #000; }
    .filter-section { background-color: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
  </style>
</head>
<body>
<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-2 bg-dark text-white vh-100 p-3">
      <h4 class="text-center mb-4">Registrar Panel</h4>
      <ul class="nav flex-column">
        <li class="nav-item mb-2">
          <a class="nav-link text-white" href="/registrar/dashboard"><i class="fa fa-home"></i> Dashboard</a>
        </li>
        <li class="nav-item mb-2">
          <a class="nav-link text-white" href="/registrar/students"><i class="fa fa-users"></i> Students</a>
        </li>
        <li class="nav-item mb-2">
          <a class="nav-link text-white" href="/registrar/subjects"><i class="fa fa-book"></i> Subjects</a>
        </li>
        <li class="nav-item mb-2">
          <a class="nav-link text-white active" href="/registrar/grades"><i class="fa fa-graduation-cap"></i> Grades</a>
        </li>
      </ul>
    </div>

    <!-- Main Content -->
    <div class="col-md-10 p-4">
      <h2 class="mb-4"><i class="fas fa-graduation-cap me-2"></i>Manage Grades</h2>

      <!-- Success/Error Alerts -->
      <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
        <span th:text="${success}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
      <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>

      <!-- Filter Section -->
      <div class="filter-section mb-4">
        <h5 class="text-primary mb-3"><i class="fas fa-filter me-2"></i>Filter Grades</h5>
        <form th:action="@{/registrar/grades}" method="get" class="row g-3">
          <div class="col-md-3">
            <label for="statusFilter" class="form-label">Status</label>
            <select class="form-select" id="statusFilter" name="status">
              <option value="">All Statuses</option>
              <option value="DRAFT" th:selected="${param.status == 'DRAFT'}">Draft</option>
              <option value="SUBMITTED_TO_REGISTRAR" th:selected="${param.status == 'SUBMITTED_TO_REGISTRAR'}">Submitted by Professor</option>
              <option value="PUBLISHED" th:selected="${param.status == 'PUBLISHED'}">Published</option>
            </select>
          </div>
          <div class="col-md-3">
            <label for="semesterFilter" class="form-label">Semester</label>
            <input type="text" class="form-control" id="semesterFilter" name="semester"
                   th:value="${param.semester}" placeholder="e.g., 2023-2024-2">
          </div>
          <div class="col-md-3">
            <label for="studentFilter" class="form-label">Student Name</label>
            <input type="text" class="form-control" id="studentFilter" name="studentName"
                   th:value="${param.studentName}" placeholder="Search student...">
          </div>
          <div class="col-md-3">
            <label class="form-label d-block">&nbsp;</label>
            <button type="submit" class="btn btn-primary"><i class="fas fa-search me-1"></i> Apply Filters</button>
            <a th:href="@{/registrar/grades}" class="btn btn-outline-secondary ms-2">Clear</a>
          </div>
        </form>
      </div>

      <!-- Grades Table -->
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h5 class="mb-0"><i class="fas fa-list me-2"></i>Submitted Grades</h5>
          <span class="badge bg-light text-dark" th:text="'Total: ' + (${grades} != null ? ${#lists.size(grades)} : 0)"></span>
        </div>
        <div class="card-body table-responsive">
          <table class="table table-bordered table-hover align-middle">
            <thead class="table-light">
            <tr>
              <th>Student ID</th>
              <th>Student Name</th>
              <th>Subject Code</th>
              <th>Subject Name</th>
              <th>Semester</th>
              <th>Grade</th>
              <th>Status</th>
              <th>Submitted At</th>
              <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="grade : ${grades}">
              <td th:text="${grade.student.studentId}">STU001</td>
              <td th:text="${grade.student.firstName + ' ' + grade.student.lastName}">John Doe</td>
              <td th:text="${grade.subject.code}">CS101</td>
              <td th:text="${grade.subject.name}">Introduction to Programming</td>
              <td th:text="${grade.semester}">2023-2024-2</td>
              <td>
                <span class="badge bg-primary fs-6" th:text="${grade.value}">1.25</span>
              </td>
              <td>
                <span th:if="${grade.status.name() == 'DRAFT'}" class="badge badge-draft">Draft</span>
                <span th:if="${grade.status.name() == 'SUBMITTED_TO_REGISTRAR'}" class="badge badge-submitted">Submitted by Professor</span>
                <span th:if="${grade.status.name() == 'PUBLISHED'}" class="badge badge-published">Published</span>
              </td>
              <td th:text="${#temporals.format(grade.createdAt, 'yyyy-MM-dd HH:mm')}">2023-12-15 14:30</td>
              <td>
                <!-- Publish button for submitted grades -->
                <form th:if="${grade.status.name() == 'SUBMITTED_TO_REGISTRAR'}"
                      th:action="@{'/registrar/grades/publish/' + ${grade.id}}"
                      method="post" style="display:inline;">
                  <button type="submit" class="btn btn-success btn-sm"
                          onclick="return confirm('Are you sure you want to publish this grade? Students will be able to see it.');">
                    <i class="fas fa-check me-1"></i> Publish
                  </button>
                </form>

                <!-- View details for published grades -->
                <span th:if="${grade.status.name() == 'PUBLISHED'}" class="text-success">
                  <i class="fas fa-check-circle me-1"></i> Published
                </span>

                <!-- Edit option for draft grades -->
                <a th:if="${grade.status.name() == 'DRAFT'}"
                   th:href="@{'/registrar/grades/edit/' + ${grade.id}}"
                   class="btn btn-warning btn-sm">
                  <i class="fas fa-edit me-1"></i> Edit
                </a>
              </td>
            </tr>
            <tr th:if="${grades == null or #lists.isEmpty(grades)}">
              <td colspan="9" class="text-center py-4">
                <i class="fas fa-inbox fa-2x text-muted mb-3"></i>
                <p class="text-muted">No grades found.</p>
                <p th:if="${param.status != null or param.semester != null or param.studentName != null}"
                   class="text-muted small">Try adjusting your filters</p>
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Bulk Actions -->
      <div th:if="${grades != null and !#lists.isEmpty(grades)}" class="mt-3">
        <div class="card">
          <div class="card-header bg-light">
            <h6 class="mb-0"><i class="fas fa-cogs me-2"></i>Bulk Actions</h6>
          </div>
          <div class="card-body">
            <form th:action="@{/registrar/grades/bulk-publish}" method="post">
              <button type="submit" class="btn btn-success"
                      onclick="return confirm('Publish all submitted grades? This will make them visible to students.');">
                <i class="fas fa-check-circle me-1"></i> Publish All Submitted Grades
              </button>
            </form>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Auto-dismiss alerts after 5 seconds
    setTimeout(function() {
      const alerts = document.querySelectorAll('.alert');
      alerts.forEach(alert => {
        const bsAlert = new bootstrap.Alert(alert);
        bsAlert.close();
      });
    }, 5000);
  });
</script>
</body>
</html>