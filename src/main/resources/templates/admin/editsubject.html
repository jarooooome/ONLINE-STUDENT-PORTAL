<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8">
  <title>Edit Subject</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <style>
    body { overflow-x: hidden; }

    .sidebar { min-height: 100vh; background-color: #343a40; padding-top: 1rem; }
    .sidebar a, .logout-form button { color: #fff; padding: 0.75rem 1.25rem; text-decoration: none; display: block; border: none; background: none; text-align: left; }
    .sidebar a:hover, .logout-form button:hover { background-color: #495057; }
    .sidebar a.active { background-color: #495057; font-weight: bold; }
    .logout-form { margin-top: auto; }
    label { font-weight: 500; }

    .form-card { border-radius: 12px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .form-actions { display: flex; gap: 12px; margin-top: 24px; padding-top: 16px; border-top: 1px solid #eee; }
    .btn-save { background-color: #28a745; color: white; border: none; padding: 10px 24px; border-radius: 8px; font-weight: 500; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .btn-save:hover { background-color: #218838; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .btn-save:active { transform: translateY(0); box-shadow: 0 2px 3px rgba(0,0,0,0.1); }
    .btn-cancel { background-color: #f8f9fa; color: #495057; border: 1px solid #dee2e6; padding: 10px 24px; border-radius: 8px; font-weight: 500; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .btn-cancel:hover { background-color: #e2e6ea; color: #212529; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .btn-cancel:active { transform: translateY(0); box-shadow: 0 2px 3px rgba(0,0,0,0.05); }

    .form-control:focus, .form-select:focus { border-color: #86b7fe; box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15); }
    .is-invalid { border-color: #dc3545; }
    .invalid-feedback { color: #dc3545; }
  </style>
</head>
<body>

<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <nav class="col-md-2 sidebar d-flex flex-column">
      <div class="text-white px-3 mb-4">
        <h4 class="mt-3">Admin Panel</h4>
        <small th:text="'Logged in as: ' + ${#authentication.name}">admin</small>
      </div>

      <a href="/admin/dashboard" class="active"><i class="fas fa-home me-2"></i>Dashboard</a>
      <a href="/admin/users"><i class="fas fa-users me-2"></i>Manage Users</a>
      <a href="/admin/students"><i class="fas fa-user-graduate me-2"></i>Student Records</a>
      <a href="/admin/courses"><i class="fas fa-graduation-cap me-2"></i>Courses</a>
      <a href="/admin/subject-schedule"><i class="fas fa-book me-2"></i>Subjects and Schedule</a>
      <a href="/admin/calendar"><i class="fas fa-calendar-alt me-2"></i>Academic Calendar</a>

      <form th:action="@{/auth/logout}" method="post" class="logout-form mt-auto px-3 py-2">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <button type="submit"><i class="fas fa-sign-out-alt me-2"></i>Logout</button>
      </form>
    </nav>

    <!-- Main Content -->
    <main class="col-md-10 p-4">
      <h2 class="mb-4">Edit Subject</h2>

      <form th:action="@{/admin/subjects/update}" th:object="${subject}" method="post" class="card shadow-sm p-4 form-card"
            id="editSubjectForm" th:data-id="${subject != null ? subject.id : 0}">
        <input type="hidden" th:field="*{id}"/>

        <div class="mb-3">
          <label for="code" class="form-label">Subject Code</label>
          <input type="text" th:field="*{code}" id="code" class="form-control" required>
          <div class="invalid-feedback" id="codeFeedback">Subject code already exists</div>
        </div>

        <div class="mb-3">
          <label for="name" class="form-label">Subject Name</label>
          <input type="text" th:field="*{name}" id="name" class="form-control" required>
          <div class="invalid-feedback" id="nameFeedback">Subject name already exists</div>
        </div>

        <div class="mb-3">
          <label for="description" class="form-label">Description</label>
          <textarea th:field="*{description}" id="description" class="form-control" rows="3"></textarea>
        </div>

        <div class="mb-3">
          <label for="semester" class="form-label">Semester</label>
          <select th:field="*{semester}" id="semester" class="form-select" required>
            <option value="" disabled>Select Semester</option>
            <option value="1st Sem" th:selected="${subject.semester=='1st Sem'}">1st Semester</option>
            <option value="2nd Sem" th:selected="${subject.semester=='2nd Sem'}">2nd Semester</option>
            <option value="3rd Sem" th:selected="${subject.semester=='3rd Sem'}">3rd Semester</option>
          </select>
        </div>

        <div class="mb-3">
          <label for="course" class="form-label">Course</label>
          <select th:field="*{course.id}" id="course" class="form-select" required>
            <option value="" disabled>Select a Course</option>
            <option th:each="c : ${courses}" th:value="${c.id}"
                    th:text="${c.title} + ' (' + ${c.code} + ')'"
                    th:selected="${subject.course != null and subject.course.id == c.id}"></option>
          </select>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn-save" id="submitBtn">
            <i class="fas fa-save me-2"></i> Update Subject
          </button>
          <a th:href="@{/admin/subjects}" class="btn-cancel">
            <i class="fas fa-times me-2"></i> Cancel
          </a>
        </div>
      </form>
    </main>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:if="${subject != null}">
  document.addEventListener('DOMContentLoaded', function() {
      const form = document.getElementById('editSubjectForm');
      const currentId = parseInt(form.dataset.id, 10);

      const codeInput = document.getElementById('code');
      const nameInput = document.getElementById('name');
      const codeFeedback = document.getElementById('codeFeedback');
      const nameFeedback = document.getElementById('nameFeedback');

      const existingSubjects = /*[[${existingSubjects}]]*/ [];
      const subjectsJS = existingSubjects.map(s => ({ id: s.id, code: s.code.toLowerCase(), name: s.name.toLowerCase() }));

      function validateField(input, feedback, field) {
          const value = input.value.trim().toLowerCase();
          const duplicate = subjectsJS.some(s => s.id !== currentId && s[field] === value);
          if (duplicate) {
              input.classList.add('is-invalid');
              feedback.style.display = 'block';
              return false;
          } else {
              input.classList.remove('is-invalid');
              feedback.style.display = 'none';
              return true;
          }
      }

      codeInput.addEventListener('blur', () => validateField(codeInput, codeFeedback, 'code'));
      nameInput.addEventListener('blur', () => validateField(nameInput, nameFeedback, 'name'));

      form.addEventListener('submit', function(e) {
          const codeValid = validateField(codeInput, codeFeedback, 'code');
          const nameValid = validateField(nameInput, nameFeedback, 'name');
          if (!codeValid || !nameValid) {
              e.preventDefault();
              const firstInvalid = form.querySelector('.is-invalid');
              if (firstInvalid) firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
      });
  });
</script>
</body>
</html>
