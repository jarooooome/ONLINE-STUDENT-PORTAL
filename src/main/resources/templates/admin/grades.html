<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-store" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
  <title>Grade Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    body { overflow-x: hidden; }
    .sidebar { min-height: 100vh; background-color: #343a40; padding-top: 1rem; }
    .sidebar a, .logout-form button { color: #fff; padding: 0.75rem 1.25rem; text-decoration: none; display: block; border: none; background: none; text-align: left; }
    .sidebar a:hover, .logout-form button:hover { background-color: #495057; }
    .sidebar a.active { background-color: #495057; font-weight: bold; }
    .logout-form { margin-top: auto; }
    .badge { font-size: 0.85rem; }
    .grade-input { width: 80px; display: inline-block; }
    .table th, .table td { vertical-align: middle; }
    .student-list {
      max-height: 500px;
      overflow-y: auto;
      margin-bottom: 20px;
    }
    .student-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    .student-item:hover, .student-item.active {
      background-color: #f8f9fa;
    }
    .student-name {
      font-weight: 500;
    }
    .no-grades {
      color: #6c757d;
      font-style: italic;
    }
    .filter-section {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
<div class="container-fluid">
  <div class="row">
    <nav class="col-md-2 sidebar d-flex flex-column">
      <div class="text-white px-3 mb-4">
        <h4 class="mt-3">Admin Panel</h4>
        <small th:text="'Logged in as: ' + ${#authentication.name}">admin</small>
      </div>
      <a href="/admin/dashboard"><i class="fas fa-home me-2"></i>Dashboard</a>
      <a href="/admin/users"><i class="fas fa-users me-2"></i>Manage Users</a>
      <a href="/admin/students"><i class="fas fa-user-graduate me-2"></i>Student Records</a>
      <a href="/admin/subjects"><i class="fas fa-book me-2"></i>Subjects</a>
      <a href="/admin/grades" class="active"><i class="fas fa-chart-line me-2"></i>Grade Management</a>
      <a href="#"><i class="fas fa-wallet me-2"></i>Tuition & Balances</a>
      <a href="/admin/calendar"><i class="fas fa-calendar-alt me-2"></i>Academic Calendar</a>
      <form th:action="@{/auth/logout}" method="post" class="logout-form mt-auto px-3 py-2">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <button type="submit"><i class="fas fa-sign-out-alt me-2"></i>Logout</button>
      </form>
    </nav>

    <main class="col-md-10 p-4">
      <h2 class="mb-4"><i class="fas fa-chart-line me-2"></i>Grade Management</h2>

      <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show mb-4" role="alert">
        <i class="fas fa-check-circle me-2"></i><span th:text="${successMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
      <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
        <i class="fas fa-exclamation-circle me-2"></i><span th:text="${errorMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>

      <!-- Filter Section -->
      <div class="card shadow-sm mb-4">
        <div class="card-header">
          <h5 class="mb-0">Filters</h5>
        </div>
        <div class="card-body">
          <form th:action="@{/admin/grades}" method="get" id="filterForm">
            <div class="row">
              <div class="col-md-3">
                <label class="form-label">Student</label>
                <select class="form-select" name="studentId">
                  <option value="">All Students</option>
                  <option th:each="student : ${students}"
                          th:value="${student.id}"
                          th:text="${student.firstName + ' ' + student.lastName}"
                          th:selected="${param.studentId != null && param.studentId == student.id.toString()}">
                  </option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Subject</label>
                <select class="form-select" name="subjectId">
                  <option value="">All Subjects</option>
                  <option th:each="subject : ${subjects}"
                          th:value="${subject.id}"
                          th:text="${subject.name}"
                          th:selected="${param.subjectId != null && param.subjectId == subject.id.toString()}">
                  </option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Section</label>
                <select class="form-select" name="sectionId">
                  <option value="">All Sections</option>
                  <option th:each="section : ${sections}"
                          th:value="${section.id}"
                          th:text="${section.name}"
                          th:selected="${param.sectionId != null && param.sectionId == section.id.toString()}">
                  </option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Course</label>
                <select class="form-select" name="courseId">
                  <option value="">All Courses</option>
                  <option th:each="course : ${courses}"
                          th:value="${course.id}"
                          th:text="${course.name}"
                          th:selected="${param.courseId != null && param.courseId == course.id.toString()}">
                  </option>
                </select>
              </div>
            </div>
            <div class="row mt-3">
              <div class="col-md-12 d-flex justify-content-end">
                <button type="submit" class="btn btn-primary me-2">
                  <i class="fas fa-filter me-2"></i>Apply Filters
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="resetFilters()">
                  <i class="fas fa-times me-2"></i>Reset
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <div class="row">
        <div class="col-md-4">
          <div class="card shadow-sm">
            <div class="card-header">
              <h5 class="mb-0">Students</h5>
            </div>
            <div class="card-body student-list">
              <div th:each="student : ${students}"
                   class="student-item"
                   th:classappend="${selectedStudent != null && selectedStudent.id == student.id} ? 'active' : ''"
                   th:onclick="'loadStudentGrades(' + ${student.id} + ')'">
                <div class="student-name" th:text="${student.firstName + ' ' + student.lastName}"></div>
                <small class="text-muted" th:text="'Section: ' + ${student.section?.name}"></small>
                <small class="text-muted" th:text="'Course: ' + ${student.course?.name}" th:if="${student.course != null}"></small>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-8">
          <div class="card shadow-sm mb-4">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addGradeModal">
                  <i class="fas fa-plus me-2"></i>Add Grades
                </button>
                <div>
                  <button class="btn btn-warning me-2" id="verifyGradesBtn">
                    <i class="fas fa-check-circle me-2"></i>Verify Grades
                  </button>
                  <button class="btn btn-primary" id="publishGradesBtn">
                    <i class="fas fa-paper-plane me-2"></i>Publish Grades
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="card shadow-sm">
            <div class="card-header">
              <h5 class="mb-0" th:if="${selectedStudent != null}"
                  th:text="'Grades for ' + ${selectedStudent.firstName} + ' ' + ${selectedStudent.lastName}"></h5>
              <h5 class="mb-0" th:if="${selectedStudent == null && param.studentId == null}">Select a student or apply filters to view grades</h5>
              <h5 class="mb-0" th:if="${selectedStudent == null && param.studentId != null}">Filtered Grades</h5>
            </div>
            <div class="card-body">
              <div th:if="${selectedStudent != null || param.studentId != null || param.subjectId != null || param.sectionId != null || param.courseId != null}">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                    <tr>
                      <th th:if="${selectedStudent == null}">Student</th>
                      <th>Subject</th>
                      <th>Section</th>
                      <th>Course</th>
                      <th>Semester</th>
                      <th>Grade</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="grade : ${grades}">
                      <td th:if="${selectedStudent == null}" th:text="${grade.student.firstName + ' ' + grade.student.lastName}"></td>
                      <td th:text="${grade.subject.name}"></td>
                      <td th:text="${grade.student.section?.name}"></td>
                      <td th:text="${grade.student.course?.name}"></td>
                      <td th:text="${grade.semester}"></td>
                      <td>
                        <span th:if="${grade.status == 'PUBLISHED'}" th:text="${grade.value}"></span>
                        <input th:if="${grade.status != 'PUBLISHED'}" type="number"
                               class="form-control grade-input"
                               th:value="${grade.value}"
                               th:data-grade-id="${grade.id}"
                               min="0" max="100" step="0.01">
                      </td>
                      <td>
                          <span th:with="status=${T(com.example.studentportal.model.GradeStatus).valueOf(grade.status)}"
                                class="badge"
                                th:classappend="${status.badgeClass}"
                                th:text="${status.displayName}">
                          </span>
                      </td>
                      <td>
                        <button class="btn btn-sm btn-outline-primary edit-grade"
                                th:data-grade-id="${grade.id}">
                          <i class="fas fa-edit"></i>
                        </button>
                        <form th:action="@{/admin/grades/delete/{id}(id=${grade.id})}"
                              method="post"
                              style="display: inline-block;">
                          <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                          <button type="submit" class="btn btn-sm btn-outline-danger"
                                  onclick="return confirm('Are you sure you want to delete this grade?')">
                            <i class="fas fa-trash"></i>
                          </button>
                        </form>
                      </td>
                    </tr>
                    <tr th:if="${grades.empty}">
                      <td th:colspan="${selectedStudent == null ? 8 : 7}" class="text-center no-grades">No grades found matching your criteria</td>
                    </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <div th:if="${selectedStudent == null && param.studentId == null && param.subjectId == null && param.sectionId == null && param.courseId == null}"
                   class="text-center no-grades">
                Please select a student from the list or apply filters to view grades
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal fade" id="addGradeModal" tabindex="-1" aria-labelledby="addGradeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="addGradeModalLabel">Add New Grade</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form th:action="@{/admin/grades/add}" method="post">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
              <div class="modal-body">
                <div class="mb-3">
                  <label class="form-label">Student</label>
                  <select class="form-select" name="studentId" required>
                    <option value="">Select Student</option>
                    <option th:each="student : ${students}"
                            th:value="${student.id}"
                            th:text="${student.firstName + ' ' + student.lastName + ' (Section: ' + (student.section?.name ?: 'None') + ', Course: ' + (student.course?.name ?: 'None') + ')'}">
                    </option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Subject</label>
                  <select class="form-select" name="subjectId" id="subjectSelect" required>
                    <option value="">Select Subject</option>
                    <option th:each="subject : ${subjects}"
                            th:value="${subject.id}"
                            th:text="${subject.name}"
                            th:attr="data-semester=${subject.semester}">
                    </option>
                  </select>
                </div>
                <div class="mb-3">
                  <label class="form-label">Semester</label>
                  <input type="text" class="form-control" name="semester" id="semesterInput" required readonly>
                </div>
                <div class="mb-3">
                  <label class="form-label">Grade (0-100)</label>
                  <input type="number" class="form-control" name="gradeValue"
                         min="0" max="100" step="0.01" required>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="submit" class="btn btn-primary">Save Grade</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
      // Handle grade input changes
      document.querySelectorAll('.grade-input').forEach(input => {
          input.addEventListener('change', function() {
              const gradeId = this.dataset.gradeId;
              const newValue = this.value;

              fetch('/admin/grades/update', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                      'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').content
                  },
                  body: JSON.stringify({
                      gradeId: gradeId,
                      value: newValue
                  })
              }).then(response => {
                  if (!response.ok) throw new Error('Error updating grade');
                  return response.json();
              }).then(data => {
                  if (data.success) location.reload();
              }).catch(error => alert(error.message));
          });
      });

      // Verify grades button
      document.getElementById('verifyGradesBtn').addEventListener('click', function() {
          const params = new URLSearchParams(window.location.search);
          if (confirm('Are you sure you want to verify all filtered grades?')) {
              fetch('/admin/grades/verify?' + params.toString(), {
                  method: 'POST',
                  headers: {
                      'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').content
                  }
              }).then(response => {
                  if (response.ok) location.reload();
                  else alert('Error verifying grades');
              });
          }
      });

      // Publish grades button
      document.getElementById('publishGradesBtn').addEventListener('click', function() {
          const params = new URLSearchParams(window.location.search);
          if (confirm('Are you sure you want to publish all filtered grades?')) {
              fetch('/admin/grades/publish?' + params.toString(), {
                  method: 'POST',
                  headers: {
                      'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').content
                  }
              }).then(response => {
                  if (response.ok) location.reload();
                  else alert('Error publishing grades');
              });
          }
      });

      // Automatically set semester based on selected subject
      document.getElementById('subjectSelect').addEventListener('change', function() {
          const selectedOption = this.options[this.selectedIndex];
          const semester = selectedOption.getAttribute('data-semester');
          document.getElementById('semesterInput').value = semester || '';
      });

      // Initialize the semester field when modal is shown
      document.getElementById('addGradeModal').addEventListener('show.bs.modal', function() {
          const subjectSelect = document.getElementById('subjectSelect');
          const selectedOption = subjectSelect.options[subjectSelect.selectedIndex];
          const semester = selectedOption ? selectedOption.getAttribute('data-semester') : '';
          document.getElementById('semesterInput').value = semester || '';
      });
  });

  function loadStudentGrades(studentId) {
      const params = new URLSearchParams(window.location.search);
      params.set('studentId', studentId);
      window.location.href = '/admin/grades?' + params.toString();
  }

  function resetFilters() {
      window.location.href = '/admin/grades';
  }
</script>
</body>
</html>